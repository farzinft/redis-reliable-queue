#!/usr/bin/env php
<?php

$files = array(
    //Add Your Application Autoload File
    __DIR__ . '/../../../../vendor/autoload.php',
    __DIR__ . '/../vendor/autoload.php',

);

foreach ($files as $file) {
    if (file_exists($file)) {
        require_once $file;
        break;
    }
}

use \Reliable\ReliableQueue;


$config = include __DIR__ . '/../config/queue.php';

$processCount = $config['PROCESS_COUNT'];

ReliableQueue::log('Started Consumer Worker');

$laravel = bootLaravel();

if ($processCount > 1) {

    for ($i = 0; $i < $processCount; $i++) {
        $pid = ReliableQueue::fork();

        if ($pid === false || $pid === -1) {
            ReliableQueue::log('Could not fork worker');
        }

        if ($pid == 0) {
            //child process
            ReliableQueue::getInstance()->dequeue($laravel);
            exit;
        }
    }
} else {
    ReliableQueue::getInstance()->dequeue($laravel);
}


function bootLaravel()
{
    $laravel = require_once __DIR__ . '/../../../../bootstrap/app.php';

    $kernel = $laravel->make(Illuminate\Contracts\Console\Kernel::class);

    $kernel->bootstrap();

    return $laravel;
}

?>


